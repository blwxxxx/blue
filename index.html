<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Î∂ÄÎ£®ÎßàÎ∏î - Blue Marble</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .game-controls {
            width: 100%;
            max-width: 1200px;
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .control-btn {
            padding: 10px 20px;
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .control-btn:hover {
            background: #667eea;
            color: white;
        }

        .game-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 1200px;
            width: 100%;
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 20px;
            font-size: 32px;
        }

        .game-info {
            text-align: center;
            margin-bottom: 15px;
            font-size: 14px;
            color: #666;
        }

        .notification-banner {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 50px;
            border-radius: 15px;
            font-size: 28px;
            font-weight: bold;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            z-index: 9999;
            animation: notificationPop 2s ease-in-out forwards;
            text-align: center;
            max-width: 80%;
            word-break: keep-all;
        }

        @keyframes notificationPop {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            10% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
            15% { transform: translate(-50%, -50%) scale(1); }
            85% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        }

        .game-board {
            position: relative;
            width: 100%;
            max-width: 750px;
            aspect-ratio: 1;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border-radius: 15px;
            box-shadow: inset 0 5px 15px rgba(0,0,0,0.1);
            display: grid;
            grid-template-columns: repeat(13, 1fr);
            grid-template-rows: repeat(13, 1fr);
            gap: 0;
            padding: 10px;
        }

        .cell {
            background: white;
            border: 2px solid #764ba2;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 9px;
            padding: 2px;
            position: relative;
            transition: all 0.3s;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
            aspect-ratio: 1;
        }

        .cell:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 3px 3px 10px rgba(0,0,0,0.2);
            z-index: 10;
        }

        .cell.corner {
            font-weight: bold;
            background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
            color: white;
            font-size: 10px;
        }

        .cell.special {
            background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);
            color: white;
            font-weight: bold;
        }

        .cell.golden {
            background: linear-gradient(135deg, #f9d423 0%, #ff4e50 100%);
            color: white;
        }

        .cell.city {
            cursor: pointer;
        }

        .cell-name {
            font-weight: bold;
            text-align: center;
            margin-bottom: 1px;
        }

        .cell-price {
            font-size: 7px;
            color: #666;
        }

        .cell-owner {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 2px solid white;
        }

        .building-indicator {
            display: flex;
            gap: 1px;
            margin-top: 1px;
            min-height: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .building {
            width: 8px;
            height: 8px;
            border-radius: 2px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            animation: buildingPop 0.3s ease-out;
        }

        .building.villa {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
        }

        .building.building-type {
            background: linear-gradient(135deg, #a29bfe, #6c5ce7);
        }

        .building.hotel {
            background: linear-gradient(135deg, #fd79a8, #e84393);
        }

        .landmark {
            width: 12px;
            height: 12px;
            background: linear-gradient(135deg, #f9d423, #ff4e50);
            border-radius: 3px;
            box-shadow: 0 2px 6px rgba(255, 215, 0, 0.8);
            animation: landmarkPulse 1.5s ease-in-out infinite;
            position: relative;
            font-size: 8px;
        }

        .landmark::before {
            content: '‚≠ê';
            position: absolute;
            top: -3px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
        }

        .olympic-marker {
            position: absolute;
            top: -2px;
            left: -2px;
            font-size: 10px;
        }

        @keyframes buildingPop {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        @keyframes landmarkPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }

        .players {
            position: absolute;
            bottom: 2px;
            left: 2px;
            display: flex;
            gap: 1px;
            flex-wrap: wrap;
        }

        .player-piece {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            border: 3px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.4);
            transition: all 0.3s;
        }

        .center-area {
            grid-column: 2 / 13;
            grid-row: 2 / 13;
            background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 15px;
        }

        .game-title {
            font-size: 28px;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 15px;
        }

        .dice-container {
            display: flex;
            gap: 12px;
            margin: 15px 0;
        }

        .dice {
            width: 50px;
            height: 50px;
            background: white;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .dice.rolling {
            animation: roll 0.5s ease-in-out;
        }

        @keyframes roll {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(90deg); }
            50% { transform: rotate(180deg); }
            75% { transform: rotate(270deg); }
        }

        .roll-button {
            padding: 12px 35px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .roll-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
        }

        .roll-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .player-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 15px;
        }

        .player-card {
            background: white;
            padding: 12px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .player-card.active {
            border: 3px solid #667eea;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
        }

        .player-card:hover .player-color {
            animation: pulse 0.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .cell.highlight {
            animation: cellBlink 0.5s infinite;
        }

        @keyframes cellBlink {
            0%, 100% { box-shadow: 0 0 0 rgba(0,0,0,0); }
            50% { box-shadow: 0 0 20px currentColor; transform: scale(1.05); }
        }

        .player-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .player-color {
            width: 22px;
            height: 22px;
            border-radius: 3px;
            border: 3px solid #333;
        }

        .player-name {
            font-weight: bold;
            font-size: 15px;
        }

        .player-money {
            color: #27ae60;
            font-weight: bold;
            font-size: 16px;
        }

        .player-properties {
            font-size: 11px;
            color: #666;
            margin-top: 4px;
        }

        .log-container {
            margin-top: 15px;
            max-height: 130px;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 12px;
            border-radius: 10px;
        }

        .log-entry {
            padding: 4px 0;
            border-bottom: 1px solid #dee2e6;
            font-size: 13px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 15px;
            max-width: 450px;
            width: 90%;
            text-align: center;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-buttons {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .modal-button {
            padding: 10px 25px;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-buy { background: #27ae60; color: white; }
        .btn-pass { background: #95a5a6; color: white; }
        .btn-build { background: #e74c3c; color: white; }
        .btn-sell { background: #e67e22; color: white; }

        .property-list {
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }

        .property-item {
            padding: 8px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .property-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .landmark-effect {
            position: fixed;
            pointer-events: none;
            font-size: 40px;
            animation: landmarkEffect 2s ease-out forwards;
            z-index: 9999;
        }

        @keyframes landmarkEffect {
            0% { transform: scale(0) rotate(0deg); opacity: 1; }
            50% { transform: scale(1.5) rotate(180deg); opacity: 1; }
            100% { transform: scale(2) rotate(360deg); opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="game-controls">
        <button class="control-btn" onclick="startGame()">Í≤åÏûÑ ÏãúÏûë</button>
        <button class="control-btn" onclick="endGame()">Í≤åÏûÑ Ï¢ÖÎ£å</button>
        <button class="control-btn" onclick="saveGame()">Ï†ÄÏû•</button>
    </div>
    
    <div class="game-container">
        <h1>üåç Î∂ÄÎ£®ÎßàÎ∏î (Blue Marble)</h1>
        <div class="game-info">ÌÑ¥: <span id="turnCount">1</span> / 100 | Î∞îÌÄ¥: <span id="lapCount">0</span></div>
        
        <div class="game-board" id="gameBoard">
            <div class="center-area">
                <div class="game-title">Î∂ÄÎ£®ÎßàÎ∏î</div>
                <div class="dice-container">
                    <div class="dice" id="dice1">6</div>
                    <div class="dice" id="dice2">6</div>
                </div>
                <button class="roll-button" id="rollButton">Ï£ºÏÇ¨ÏúÑ Íµ¥Î¶¨Í∏∞</button>
                <div id="currentTurn" style="margin-top: 10px; font-size: 14px; font-weight: bold; color: white;">ÌÑ¥: ÎÇò</div>
            </div>
        </div>

        <div class="player-info" id="playerInfo"></div>
        <div class="log-container" id="logContainer"></div>
    </div>

    <div class="modal" id="actionModal">
        <div class="modal-content">
            <h2 id="modalTitle">ÏïåÎ¶º</h2>
            <p id="modalText"></p>
            <div id="modalExtra"></div>
            <div class="modal-buttons" id="modalButtons"></div>
        </div>
    </div>

    <script>
        const boardLayout = [
            'Ï∂úÎ∞ú', 'ÌÉÄÏù¥ÌéòÏù¥', 'Ìô©Í∏àÏó¥Ïá†', 'Î≤†Ïù¥Ïßï', 'ÎßàÎãêÎùº', 'Ï†úÏ£ºÎèÑ', 'Ïã±Í∞ÄÌè¨Î•¥', 'Ìô©Í∏àÏó¥Ïá†', 'Ïπ¥Ïù¥Î°ú', 'Ïù¥Ïä§ÌÉÑÎ∂à',
            'Î¨¥Ïù∏ÎèÑ', 'ÏïÑÌÖåÎÑ§', 'Ìô©Í∏àÏó¥Ïá†', 'ÏΩîÌéúÌïòÍ≤ê', 'Ïä§ÌÜ°ÌôÄÎ¶Ñ', 'ÏΩ©ÏΩîÎìú', 'Î≤†Î•∏', 'Ìô©Í∏àÏó¥Ïá†', 'Î≤†Î•ºÎ¶∞', 'Ïò§ÌÉÄÏôÄ',
            'Ïò¨Î¶ºÌîΩ', 'Î∂ÄÏóêÎÖ∏Ïä§', 'Ìô©Í∏àÏó¥Ïá†', 'ÏÉÅÌååÏö∏Î£®', 'ÏãúÎìúÎãà', 'Î∂ÄÏÇ∞', 'ÌïòÏôÄÏù¥', 'Î¶¨Ïä§Î≥∏', 'ÌÄ∏ÏóòÎ¶¨ÏûêÎ≤†Ïä§', 'ÎßàÎìúÎ¶¨Îìú',
            'ÎπÑÌñâÍ∏∞', 'ÎèÑÏøÑ', 'Ïª¨ÎüºÎπÑÏïÑ', 'ÌååÎ¶¨', 'Î°úÎßà', 'Ìô©Í∏àÏó¥Ïá†', 'Îü∞Îçò', 'Îâ¥Ïöï', 'Ìô©Í∏àÏó¥Ïá†', 'ÏÑúÏö∏'
        ];

        const cityData = {
            'ÌÉÄÏù¥ÌéòÏù¥': { land: 50000, villa: 50000, building: 150000, hotel: 250000, rentLand: 2000, rentVilla: 10000, rentBuilding: 90000, rentHotel: 250000 },
            'Î≤†Ïù¥Ïßï': { land: 80000, villa: 50000, building: 150000, hotel: 250000, rentLand: 4000, rentVilla: 20000, rentBuilding: 180000, rentHotel: 450000 },
            'ÎßàÎãêÎùº': { land: 80000, villa: 50000, building: 150000, hotel: 250000, rentLand: 4000, rentVilla: 20000, rentBuilding: 180000, rentHotel: 450000 },
            'Ï†úÏ£ºÎèÑ': { land: 200000, special: true, rent: 300000 },
            'Ïã±Í∞ÄÌè¨Î•¥': { land: 100000, villa: 50000, building: 150000, hotel: 250000, rentLand: 6000, rentVilla: 30000, rentBuilding: 270000, rentHotel: 550000 },
            'Ïπ¥Ïù¥Î°ú': { land: 100000, villa: 50000, building: 150000, hotel: 250000, rentLand: 6000, rentVilla: 30000, rentBuilding: 270000, rentHotel: 550000 },
            'Ïù¥Ïä§ÌÉÑÎ∂à': { land: 120000, villa: 50000, building: 150000, hotel: 250000, rentLand: 8000, rentVilla: 40000, rentBuilding: 300000, rentHotel: 600000 },
            'ÏïÑÌÖåÎÑ§': { land: 140000, villa: 100000, building: 300000, hotel: 500000, rentLand: 10000, rentVilla: 150000, rentBuilding: 450000, rentHotel: 750000 },
            'ÏΩîÌéúÌïòÍ≤ê': { land: 160000, villa: 100000, building: 300000, hotel: 500000, rentLand: 12000, rentVilla: 180000, rentBuilding: 500000, rentHotel: 900000 },
            'Ïä§ÌÜ°ÌôÄÎ¶Ñ': { land: 160000, villa: 100000, building: 300000, hotel: 500000, rentLand: 12000, rentVilla: 180000, rentBuilding: 500000, rentHotel: 900000 },
            'ÏΩ©ÏΩîÎìú': { land: 200000, special: true, rent: 300000 },
            'Î≤†Î•∏': { land: 180000, villa: 100000, building: 300000, hotel: 500000, rentLand: 14000, rentVilla: 200000, rentBuilding: 550000, rentHotel: 950000 },
            'Î≤†Î•ºÎ¶∞': { land: 180000, villa: 100000, building: 300000, hotel: 500000, rentLand: 14000, rentVilla: 200000, rentBuilding: 550000, rentHotel: 950000 },
            'Ïò§ÌÉÄÏôÄ': { land: 200000, villa: 100000, building: 300000, hotel: 500000, rentLand: 16000, rentVilla: 220000, rentBuilding: 600000, rentHotel: 1000000 },
            'Î∂ÄÏóêÎÖ∏Ïä§': { land: 220000, villa: 150000, building: 400000, hotel: 750000, rentLand: 18000, rentVilla: 250000, rentBuilding: 700000, rentHotel: 1050000 },
            'ÏÉÅÌååÏö∏Î£®': { land: 240000, villa: 150000, building: 450000, hotel: 750000, rentLand: 20000, rentVilla: 300000, rentBuilding: 750000, rentHotel: 1100000 },
            'ÏãúÎìúÎãà': { land: 240000, villa: 150000, building: 450000, hotel: 750000, rentLand: 20000, rentVilla: 300000, rentBuilding: 750000, rentHotel: 1100000 },
            'Î∂ÄÏÇ∞': { land: 500000, special: true, rent: 600000 },
            'ÌïòÏôÄÏù¥': { land: 260000, villa: 150000, building: 450000, hotel: 750000, rentLand: 22000, rentVilla: 330000, rentBuilding: 800000, rentHotel: 1150000 },
            'Î¶¨Ïä§Î≥∏': { land: 260000, villa: 150000, building: 450000, hotel: 750000, rentLand: 22000, rentVilla: 330000, rentBuilding: 800000, rentHotel: 1150000 },
            'ÌÄ∏ÏóòÎ¶¨ÏûêÎ≤†Ïä§': { land: 300000, special: true, rent: 250000 },
            'ÎßàÎìúÎ¶¨Îìú': { land: 280000, villa: 150000, building: 450000, hotel: 750000, rentLand: 24000, rentVilla: 360000, rentBuilding: 850000, rentHotel: 1200000 },
            'ÎèÑÏøÑ': { land: 300000, villa: 200000, building: 600000, hotel: 1000000, rentLand: 26000, rentVilla: 390000, rentBuilding: 900000, rentHotel: 1270000 },
            'Ïª¨ÎüºÎπÑÏïÑ': { land: 450000, special: true, rent: 300000 },
            'ÌååÎ¶¨': { land: 320000, villa: 200000, building: 600000, hotel: 1000000, rentLand: 28000, rentVilla: 450000, rentBuilding: 1000000, rentHotel: 1400000 },
            'Î°úÎßà': { land: 320000, villa: 200000, building: 600000, hotel: 1000000, rentLand: 28000, rentVilla: 450000, rentBuilding: 1000000, rentHotel: 1400000 },
            'Îü∞Îçò': { land: 350000, villa: 200000, building: 600000, hotel: 1000000, rentLand: 35000, rentVilla: 500000, rentBuilding: 1100000, rentHotel: 1500000 },
            'Îâ¥Ïöï': { land: 350000, villa: 200000, building: 600000, hotel: 1000000, rentLand: 35000, rentVilla: 500000, rentBuilding: 1100000, rentHotel: 1500000 },
            'ÏÑúÏö∏': { land: 1000000, special: true, rent: 2000000 }
        };

        const goldenKeys = [
            { text: 'Í∞ÄÏû• ÎπÑÏãº ÎïÖÏùÑ Î∞òÍ∞íÏúºÎ°ú ÏùÄÌñâÏóê ÌåêÎã§', type: 'sell_expensive' },
            { text: 'Í±¥Î¨º Ïú†ÏßÄÎπÑ ÏßÄÎ∂à (Ìò∏ÌÖî 15Îßå/ÎπåÎî© 10Îßå/Î≥ÑÏû• 3Îßå)', type: 'maintain' },
            { text: 'Í±¥Î¨º ÏàòÎ¶¨ÎπÑ ÏßÄÎ∂à (Ìò∏ÌÖî 10Îßå/ÎπåÎî© 6Îßå/Î≥ÑÏû• 3Îßå)', type: 'repair' },
            { text: 'Î∞©Î≤îÎπÑ ÏßÄÎ∂à (Ìò∏ÌÖî 5Îßå/ÎπåÎî© 3Îßå/Î≥ÑÏû• 1Îßå)', type: 'security' },
            { text: 'Î¨¥Ïù∏ÎèÑ ÌÉàÏ∂ú Ïπ¥Îìú', type: 'escape', keep: true },
            { text: 'ÌÜµÌñâÎ£å Î©¥Ï†úÍ∂å (1Ìöå)', type: 'immunity', keep: true },
            { text: 'Îí§Î°ú 2Ïπ∏ Ïù¥Îèô', type: 'back', steps: 2 },
            { text: 'Îí§Î°ú 3Ïπ∏ Ïù¥Îèô', type: 'back', steps: 3 },
            { text: 'Ï†úÏ£ºÎèÑÎ°ú Í∞ÄÏãúÏò§', type: 'move', target: 'Ï†úÏ£ºÎèÑ' },
            { text: 'Î∂ÄÏÇ∞ÏúºÎ°ú Í∞ÄÏãúÏò§', type: 'move', target: 'Î∂ÄÏÇ∞' },
            { text: 'ÏÑúÏö∏Î°ú Í∞ÄÏãúÏò§', type: 'move', target: 'ÏÑúÏö∏' },
            { text: 'Î¨¥Ïù∏ÎèÑÎ°ú Í∞ÄÏãúÏò§', type: 'move', target: 'Î¨¥Ïù∏ÎèÑ' },
            { text: 'ÎπÑÌñâÍ∏∞Î°ú Í∞ÄÏãúÏò§ (ÏõîÍ∏â 20ÎßåÏõê Î∞õÏùå)', type: 'move', target: 'ÎπÑÌñâÍ∏∞', salary: true },
            { text: 'Ï∂úÎ∞úÏßÄÎ°ú Í∞ÄÏãúÏò§ (ÏõîÍ∏â 20ÎßåÏõê Î∞õÏùå)', type: 'move', target: 'Ï∂úÎ∞ú', salary: true },
            { text: 'ÏÉùÏùº Ï∂ïÌïòÍ∏à 50ÎßåÏõê', type: 'money', amount: 500000 },
            { text: 'ÎÖ∏Î≤®ÌèâÌôîÏÉÅ 30ÎßåÏõê', type: 'money', amount: 300000 },
            { text: 'Î≥µÍ∂å ÎãπÏ≤® 20ÎßåÏõê', type: 'money', amount: 200000 },
            { text: 'Í≥ºÏÜçÏö¥Ï†Ñ Î≤åÍ∏à 5ÎßåÏõê', type: 'pay', amount: 50000 },
            { text: 'Ìï¥Ïô∏Ïú†Ìïô ÎπÑÏö© 10ÎßåÏõê', type: 'pay', amount: 100000 },
            { text: 'ÏÉÅÎåÄÎ∞© Í±¥Î¨º ÌååÍ¥¥Í∂å', type: 'destroy', keep: true }
        ];

        let gameState = {
            players: [],
            currentPlayer: 0,
            turn: 1,
            goldenKeyDeck: [],
            olympicCity: null,
            airplaneNext: null
        };

        function initGame() {
            // Ï†ÄÏû•Îêú Í≤åÏûÑ Î∂àÎü¨Ïò§Í∏∞
            const saved = localStorage.getItem('bluemarble_save');
            if (saved) {
                try {
                    gameState = JSON.parse(saved);
                    createBoard();
                    updateAll();
                    addLog('Ï†ÄÏû•Îêú Í≤åÏûÑÏùÑ Î∂àÎü¨ÏôîÏäµÎãàÎã§.');
                    return;
                } catch (e) {
                    console.error('Ï†ÄÏû• Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', e);
                }
            }
            
            gameState.players = ['ÎÇò', 'CPU 1', 'CPU 2', 'CPU 3'].map((name, i) => ({
                name,
                color: ['#3498db', '#e74c3c', '#2ecc71', '#f39c12'][i],
                money: 2000000,
                position: 0,
                properties: [],
                laps: 0,
                isAI: i > 0,
                bankrupt: false,
                isOnIsland: 0,
                cards: { escape: 0, immunity: 0, destroy: 0 }
            }));
            
            gameState.goldenKeyDeck = shuffleArray([...goldenKeys, ...goldenKeys, ...goldenKeys]);
            createBoard();
            updateAll();
            addLog('üéÆ Í≤åÏûÑ ÏãúÏûë! Í∞Å ÌîåÎ†àÏù¥Ïñ¥Îäî 200ÎßåÏõêÏùÑ Î∞õÏïòÏäµÎãàÎã§.');
            saveGame();
        }

        window.startGame = function() {
            if (confirm('ÏÉà Í≤åÏûÑÏùÑ ÏãúÏûëÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                localStorage.removeItem('bluemarble_save');
                location.reload();
            }
        };

        window.endGame = function() {
            if (confirm('Í≤åÏûÑÏùÑ Ï¢ÖÎ£åÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                localStorage.removeItem('bluemarble_save');
                location.reload();
            }
        };

        window.saveGame = function() {
            try {
                localStorage.setItem('bluemarble_save', JSON.stringify(gameState));
                addLog('Í≤åÏûÑÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.');
            } catch (e) {
                console.error('Ï†ÄÏû• Ïã§Ìå®:', e);
            }
        };

        function shuffleArray(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        function createBoard() {
            const board = document.getElementById('gameBoard');
            const positions = [];
            
            // Ï¢åÌïòÎã®(Ï∂úÎ∞ú0) ‚Üí Ïö∞ÌïòÎã®(Ïù¥Ïä§ÌÉÑÎ∂à9): ÌïòÎã® ÎùºÏù∏
            for (let i = 0; i < 10; i++) {
                positions.push({ pos: i, row: 13, col: i + 1 });
            }
            
            // Ïö∞ÌïòÎã®(Ïù¥Ïä§ÌÉÑÎ∂à9) Îã§Ïùå Î¨¥Ïù∏ÎèÑ(10) ÏãúÏûë
            // Î¨¥Ïù∏ÎèÑ(10) ‚Üí Ïò¨Î¶ºÌîΩ(20): Ïö∞Ï∏° ÎùºÏù∏
            for (let i = 10; i <= 20; i++) {
                positions.push({ pos: i, row: 13 - (i - 10), col: 11 });
            }
            
            // Ïò¨Î¶ºÌîΩ(20) ‚Üí ÎπÑÌñâÍ∏∞(30): ÏÉÅÎã® ÎùºÏù∏
            for (let i = 21; i <= 30; i++) {
                positions.push({ pos: i, row: 4, col: 11 - (i - 20) });
            }
            
            // ÎπÑÌñâÍ∏∞(30) ‚Üí ÏÑúÏö∏(39): Ï¢åÏ∏° ÎùºÏù∏
            for (let i = 31; i <= 39; i++) {
                positions.push({ pos: i, row: 4 + (i - 30), col: 1 });
            }

            positions.forEach(cell => {
                const cellDiv = document.createElement('div');
                cellDiv.className = 'cell';
                const cityName = boardLayout[cell.pos];
                
                if (['Ï∂úÎ∞ú', 'Î¨¥Ïù∏ÎèÑ', 'Ïò¨Î¶ºÌîΩ', 'ÎπÑÌñâÍ∏∞'].includes(cityName)) {
                    cellDiv.classList.add('corner');
                } else if (cityName === 'Ìô©Í∏àÏó¥Ïá†') {
                    cellDiv.classList.add('golden');
                } else if (['Ï†úÏ£ºÎèÑ', 'ÏΩ©ÏΩîÎìú', 'Î∂ÄÏÇ∞', 'ÌÄ∏ÏóòÎ¶¨ÏûêÎ≤†Ïä§', 'Ïª¨ÎüºÎπÑÏïÑ'].includes(cityName)) {
                    cellDiv.classList.add('special');
                } else if (cityData[cityName]) {
                    cellDiv.classList.add('city');
                }
                
                cellDiv.style.gridRow = cell.row;
                cellDiv.style.gridColumn = cell.col;
                cellDiv.dataset.position = cell.pos;
                
                const price = cityData[cityName] ? (cityData[cityName].land / 10000) + 'Îßå' : '';
                cellDiv.innerHTML = `
                    <div class="cell-name">${cityName}</div>
                    ${price ? `<div class="cell-price">${price}</div>` : ''}
                    <div class="building-indicator"></div>
                    <div class="players"></div>
                `;
                
                board.appendChild(cellDiv);
            });
            
            updatePlayerPositions();
        }

        function updatePlayerPositions() {
            document.querySelectorAll('.players').forEach(el => el.innerHTML = '');
            
            gameState.players.forEach(player => {
                if (player.bankrupt) return;
                const cell = document.querySelector(`[data-position="${player.position}"]`);
                if (cell) {
                    const piece = document.createElement('div');
                    piece.className = 'player-piece';
                    piece.style.background = player.color;
                    cell.querySelector('.players').appendChild(piece);
                }
            });
        }

        function updateAll() {
            updatePlayerInfo();
            updatePlayerPositions();
            document.getElementById('turnCount').textContent = gameState.turn;
            document.getElementById('lapCount').textContent = gameState.players[gameState.currentPlayer].laps;
            saveGame();
        }

        function updatePlayerInfo() {
            document.getElementById('playerInfo').innerHTML = gameState.players.map((p, i) => `
                <div class="player-card ${i === gameState.currentPlayer ? 'active' : ''} ${p.bankrupt ? 'bankrupt' : ''}" 
                     onmouseenter="highlightProperties('${p.name}')" 
                     onmouseleave="unhighlightProperties()">
                    <div class="player-header">
                        <div class="player-color" style="background: ${p.color}"></div>
                        <div class="player-name">${p.name}${p.bankrupt ? ' (ÌååÏÇ∞)' : ''}</div>
                    </div>
                    <div class="player-money">üí∞ ${p.money.toLocaleString()}Ïõê</div>
                    <div class="player-properties">
                        ÎèÑÏãú: ${p.properties.length}Í∞ú | Î∞îÌÄ¥: ${p.laps}<br>
                        ${p.cards.escape > 0 ? `üîë ÌÉàÏ∂ú: ${p.cards.escape} ` : ''}
                        ${p.cards.immunity > 0 ? `üé´ Î©¥Ï†ú: ${p.cards.immunity} ` : ''}
                        ${p.cards.destroy > 0 ? `üí• ÌååÍ¥¥: ${p.cards.destroy}` : ''}
                        ${p.isOnIsland > 0 ? `<br>üèùÔ∏è Î¨¥Ïù∏ÎèÑ ${p.isOnIsland}ÌÑ¥Ïß∏` : ''}
                    </div>
                </div>
            `).join('');
        }

        window.highlightProperties = function(playerName) {
            const player = gameState.players.find(p => p.name === playerName);
            if (!player) return;
            
            player.properties.forEach(prop => {
                const pos = boardLayout.indexOf(prop.name);
                const cell = document.querySelector(`[data-position="${pos}"]`);
                if (cell) {
                    cell.classList.add('highlight');
                    cell.style.color = player.color;
                }
            });
        };

        window.unhighlightProperties = function() {
            document.querySelectorAll('.cell.highlight').forEach(cell => {
                cell.classList.remove('highlight');
                cell.style.color = '';
            });
        };

        function rollDice() {
            const player = gameState.players[gameState.currentPlayer];
            if (player.bankrupt) { nextTurn(); return; }
            
            if (gameState.airplaneNext === gameState.currentPlayer) {
                showAirplaneChoice();
                return;
            }
            
            if (player.isOnIsland > 0) {
                handleIsland();
                return;
            }
            
            document.getElementById('rollButton').disabled = true;
            const dice1El = document.getElementById('dice1');
            const dice2El = document.getElementById('dice2');
            
            dice1El.classList.add('rolling');
            dice2El.classList.add('rolling');
            
            setTimeout(() => {
                const dice1 = Math.floor(Math.random() * 6) + 1;
                const dice2 = Math.floor(Math.random() * 6) + 1;
                
                dice1El.textContent = dice1;
                dice2El.textContent = dice2;
                dice1El.classList.remove('rolling');
                dice2El.classList.remove('rolling');
                
                const isDouble = dice1 === dice2;
                addLog(`${player.name}: ${dice1} + ${dice2} = ${dice1 + dice2}${isDouble ? ' üé≤ÎçîÎ∏î!' : ''}`);
                if (isDouble) {
                    showNotification(`üé≤ ÎçîÎ∏î!\n${player.name}`);
                }
                
                movePlayer(dice1 + dice2, isDouble);
            }, 500);
        }

        function handleIsland() {
            const player = gameState.players[gameState.currentPlayer];
            
            if (player.cards.escape > 0) {
                showModal('Î¨¥Ïù∏ÎèÑ', 'ÌÉàÏ∂ú Ïπ¥ÎìúÎ•º ÏÇ¨Ïö©ÌïòÏãúÍ≤†ÏäµÎãàÍπå?', [
                    { text: 'ÏÇ¨Ïö©', class: 'btn-buy', action: () => {
                        player.cards.escape--;
                        player.isOnIsland = 0;
                        addLog(`${player.name}Ïù¥(Í∞Ä) ÌÉàÏ∂ú Ïπ¥Îìú ÏÇ¨Ïö©!`);
                        closeModal();
                        updateAll();
                        setTimeout(rollDice, 500);
                    }},
                    { text: 'Ï£ºÏÇ¨ÏúÑ', class: 'btn-pass', action: () => {
                        closeModal();
                        tryIslandDice();
                    }}
                ]);
                return;
            }
            
            tryIslandDice();
        }

        function tryIslandDice() {
            const player = gameState.players[gameState.currentPlayer];
            const dice1 = Math.floor(Math.random() * 6) + 1;
            const dice2 = Math.floor(Math.random() * 6) + 1;
            
            document.getElementById('dice1').textContent = dice1;
            document.getElementById('dice2').textContent = dice2;
            
            if (dice1 === dice2) {
                player.isOnIsland = 0;
                addLog(`${player.name} ÎçîÎ∏îÎ°ú ÌÉàÏ∂ú! üé≤`);
                movePlayer(dice1 + dice2, false);
            } else {
                player.isOnIsland++;
                if (player.isOnIsland >= 3) {
                    player.isOnIsland = 0;
                    addLog(`${player.name} 3ÌÑ¥ ÌõÑ ÏûêÎèô ÌÉàÏ∂ú`);
                } else {
                    addLog(`${player.name} Î¨¥Ïù∏ÎèÑ ${player.isOnIsland}ÌÑ¥Ïß∏...`);
                }
                updateAll();
                nextTurn();
            }
        }

        function movePlayer(steps, isDouble) {
            const player = gameState.players[gameState.currentPlayer];
            const oldPos = player.position;
            player.position = (player.position + steps) % 40;
            
            if (player.position < oldPos) {
                player.laps++;
                player.money += 200000;
                addLog(`${player.name} Ï∂úÎ∞ú ÌÜµÍ≥º! ÏõîÍ∏â 20ÎßåÏõê üí∞`);
            }
            
            updatePlayerPositions();
            setTimeout(() => handleLanding(isDouble), 600);
        }

        function handleLanding(isDouble) {
            const player = gameState.players[gameState.currentPlayer];
            const cityName = boardLayout[player.position];
            
            if (cityName === 'Ìô©Í∏àÏó¥Ïá†') {
                handleGoldenKey(isDouble);
            } else if (cityName === 'Î¨¥Ïù∏ÎèÑ') {
                player.isOnIsland = 1;
                addLog(`${player.name} Î¨¥Ïù∏ÎèÑ Í∞áÌûò! üèùÔ∏è`);
                updateAll();
                nextTurn();
            } else if (cityName === 'Ïò¨Î¶ºÌîΩ') {
                handleOlympic(isDouble);
            } else if (cityName === 'ÎπÑÌñâÍ∏∞') {
                gameState.airplaneNext = gameState.currentPlayer;
                addLog(`${player.name} ÎπÑÌñâÍ∏∞ ÌÉëÏäπ! ‚úàÔ∏è Îã§Ïùå ÌÑ¥Ïóê ÏõêÌïòÎäî Í≥≥ÏúºÎ°ú`);
                nextTurn();
            } else if (cityData[cityName]) {
                handleCity(cityName, isDouble);
            } else {
                if (isDouble) setTimeout(rollDice, 800);
                else nextTurn();
            }
        }

        function handleGoldenKey(isDouble) {
            const player = gameState.players[gameState.currentPlayer];
            const card = gameState.goldenKeyDeck.shift();
            gameState.goldenKeyDeck.push(card);
            
            addLog(`üîë ${player.name}: ${card.text}`);
            showNotification(`${player.name}\nüîë Ìô©Í∏àÏó¥Ïá†\n${card.text}`);
            
            if (card.keep) {
                if (card.type === 'escape') player.cards.escape++;
                if (card.type === 'immunity') player.cards.immunity++;
                if (card.type === 'destroy') player.cards.destroy++;
                updateAll();
                if (isDouble) setTimeout(rollDice, 2000);
                else setTimeout(nextTurn, 2000);
                return;
            }
            
            if (card.type === 'money') {
                player.money += card.amount;
            } else if (card.type === 'pay') {
                player.money -= card.amount;
            } else if (card.type === 'maintain') {
                let cost = 0;
                player.properties.forEach(p => {
                    if (p.villa) cost += 30000;
                    if (p.building) cost += 100000;
                    if (p.hotel) cost += 150000;
                });
                player.money -= cost;
                addLog(`Ïú†ÏßÄÎπÑ ${cost.toLocaleString()}Ïõê ÏßÄÎ∂à`);
            } else if (card.type === 'repair') {
                let cost = 0;
                player.properties.forEach(p => {
                    if (p.villa) cost += 30000;
                    if (p.building) cost += 60000;
                    if (p.hotel) cost += 100000;
                });
                player.money -= cost;
                addLog(`ÏàòÎ¶¨ÎπÑ ${cost.toLocaleString()}Ïõê ÏßÄÎ∂à`);
            } else if (card.type === 'security') {
                let cost = 0;
                player.properties.forEach(p => {
                    if (p.villa) cost += 10000;
                    if (p.building) cost += 30000;
                    if (p.hotel) cost += 50000;
                });
                player.money -= cost;
                addLog(`Î∞©Î≤îÎπÑ ${cost.toLocaleString()}Ïõê ÏßÄÎ∂à`);
            } else if (card.type === 'sell_expensive') {
                const sorted = player.properties.sort((a,b) => cityData[b.name].land - cityData[a.name].land);
                if (sorted[0]) {
                    const prop = sorted[0];
                    let sellPrice = cityData[prop.name].land / 2;
                    if (prop.villa) sellPrice += cityData[prop.name].villa / 2;
                    if (prop.building) sellPrice += cityData[prop.name].building / 2;
                    if (prop.hotel) sellPrice += cityData[prop.name].hotel / 2;
                    player.money += sellPrice;
                    player.properties = player.properties.filter(p => p !== prop);
                    addLog(`${prop.name} Î∞òÍ∞í Îß§Í∞Å: ${sellPrice.toLocaleString()}Ïõê`);
                    updateCityDisplay(prop.name, null);
                }
            } else if (card.type === 'back') {
                player.position = Math.max(0, player.position - card.steps);
                updatePlayerPositions();
                setTimeout(() => handleLanding(false), 2600);
                return;
            } else if (card.type === 'move') {
                const targetPos = boardLayout.indexOf(card.target);
                if (card.salary && targetPos < player.position) {
                    player.money += 200000;
                    addLog(`ÏõîÍ∏â 20ÎßåÏõê Î∞õÏùå`);
                }
                player.position = targetPos;
                updatePlayerPositions();
                setTimeout(() => handleLanding(false), 2600);
                return;
            }
            
            updateAll();
            if (isDouble) setTimeout(rollDice, 2500);
            else setTimeout(nextTurn, 2500);
        }

        function handleCity(cityName, isDouble) {
            const player = gameState.players[gameState.currentPlayer];
            const owner = gameState.players.find(p => p.properties.some(pr => pr.name === cityName));
            
            if (!owner) {
                if (player.isAI) {
                    setTimeout(() => {
                        if (player.money > cityData[cityName].land * 2 && Math.random() > 0.3) {
                            const buildLevel = player.laps >= 4 && Math.random() > 0.5 ? 'hotel' : 
                                             player.laps >= 2 && Math.random() > 0.6 ? 'building' :
                                             player.laps >= 1 && Math.random() > 0.7 ? 'villa' : 'land';
                            buyCity(cityName, isDouble, buildLevel);
                        } else {
                            if (isDouble) setTimeout(rollDice, 500);
                            else nextTurn();
                        }
                    }, 1000);
                } else {
                    showBuyModal(cityName, isDouble);
                }
            } else if (owner === player) {
                if (player.isAI) {
                    setTimeout(() => aiBuild(cityName, isDouble), 1000);
                } else {
                    showBuildModal(cityName, isDouble);
                }
            } else {
                payRent(cityName, owner, isDouble);
            }
        }

        function showBuyModal(cityName, isDouble) {
            const data = cityData[cityName];
            const price = data.land;
            
            showModal(`${cityName} Íµ¨Îß§`, `Í∞ÄÍ≤©: ${price.toLocaleString()}Ïõê`, [
                { text: 'Íµ¨Îß§', class: 'btn-buy', action: () => { buyCity(cityName, isDouble); }},
                { text: 'Ìè¨Í∏∞', class: 'btn-pass', action: () => { 
                    closeModal();
                    if (isDouble) setTimeout(rollDice, 500);
                    else nextTurn();
                }}
            ]);
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification-banner';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 2000);
        }

        function buyCity(cityName, isDouble) {
            const player = gameState.players[gameState.currentPlayer];
            const price = cityData[cityName].land;
            
            if (player.money >= price) {
                player.money -= price;
                player.properties.push({ 
                    name: cityName, 
                    villa: false, 
                    building: false, 
                    hotel: false, 
                    landmark: false 
                });
                addLog(`${player.name} ${cityName} Íµ¨Îß§!`);
                showNotification(`${player.name}\n${cityName} Íµ¨Îß§!`);
                updateCityDisplay(cityName, player);
                updateAll();
            }
            
            closeModal();
            if (isDouble) setTimeout(rollDice, 2000);
            else setTimeout(nextTurn, 2000);
        }

        function showBuildModal(cityName, isDouble) {
            const player = gameState.players[gameState.currentPlayer];
            const prop = player.properties.find(p => p.name === cityName);
            const data = cityData[cityName];
            
            if (data.special) {
                if (isDouble) setTimeout(rollDice, 500);
                else nextTurn();
                return;
            }
            
            const maxBuildings = Math.min(3, player.laps);
            const buttons = [];
            let info = `Í±¥Î¨º: ${prop.villa?'Î≥ÑÏû• ':''}${prop.building?'ÎπåÎî© ':''}${prop.hotel?'Ìò∏ÌÖî ':''}`;
            
            if (!prop.villa && maxBuildings >= 1) {
                buttons.push({ text: `Î≥ÑÏû• ÏßìÍ∏∞ (${(data.villa/10000)}Îßå)`, class: 'btn-build', 
                    action: () => { build(cityName, 'villa', isDouble); }});
            }
            if (prop.villa && !prop.building && maxBuildings >= 2) {
                buttons.push({ text: `ÎπåÎî© ÏßìÍ∏∞ (${(data.building/10000)}Îßå)`, class: 'btn-build', 
                    action: () => { build(cityName, 'building', isDouble); }});
            }
            if (prop.building && !prop.hotel && maxBuildings >= 3) {
                buttons.push({ text: `Ìò∏ÌÖî ÏßìÍ∏∞ (${(data.hotel/10000)}Îßå)`, class: 'btn-build', 
                    action: () => { build(cityName, 'hotel', isDouble); }});
            }
            if (prop.villa && prop.building && prop.hotel && !prop.landmark) {
                const landmarkPrice = data.hotel * 2;
                buttons.push({ text: `ÎûúÎìúÎßàÌÅ¨ Í±¥ÏÑ§ (${(landmarkPrice/10000)}Îßå)`, class: 'btn-buy', 
                    action: () => { buildLandmark(cityName, isDouble); }});
            }
            
            buttons.push({ text: 'Îã§ÏùåÏóê', class: 'btn-pass', action: () => { 
                closeModal();
                if (isDouble) setTimeout(rollDice, 500);
                else nextTurn();
            }});
            
            showModal(`${cityName} Í±¥ÏÑ§`, info, buttons);
        }

        function build(cityName, type, isDouble) {
            const player = gameState.players[gameState.currentPlayer];
            const prop = player.properties.find(p => p.name === cityName);
            const data = cityData[cityName];
            const price = data[type];
            
            if (player.money >= price) {
                player.money -= price;
                prop[type] = true;
                const typeName = type==='villa'?'Î≥ÑÏû•':type==='building'?'ÎπåÎî©':'Ìò∏ÌÖî';
                addLog(`${player.name} ${cityName}Ïóê ${typeName} Í±¥ÏÑ§!`);
                showNotification(`${player.name}\n${cityName} ${typeName} Íµ¨Îß§!`);
                updateCityDisplay(cityName, player);
                updateAll();
            }
            
            closeModal();
            if (isDouble) setTimeout(rollDice, 2000);
            else setTimeout(nextTurn, 2000);
        }

        function buildLandmark(cityName, isDouble) {
            const player = gameState.players[gameState.currentPlayer];
            const prop = player.properties.find(p => p.name === cityName);
            const price = cityData[cityName].hotel * 2;
            
            if (player.money >= price) {
                player.money -= price;
                prop.landmark = true;
                showLandmarkEffect();
                addLog(`üåü ${player.name} ${cityName} ÎûúÎìúÎßàÌÅ¨ ÏôÑÏÑ±!`);
                updateCityDisplay(cityName, player);
                updateAll();
            }
            
            closeModal();
            if (isDouble) setTimeout(rollDice, 800);
            else nextTurn();
        }

        function payRent(cityName, owner, isDouble) {
            const player = gameState.players[gameState.currentPlayer];
            const prop = owner.properties.find(p => p.name === cityName);
            const data = cityData[cityName];
            
            let rent = 0;
            if (data.special) {
                rent = data.rent;
            } else {
                if (prop.landmark) {
                    rent = data.rentHotel * 2;
                } else if (prop.hotel) {
                    rent = data.rentHotel;
                } else if (prop.building) {
                    rent = data.rentBuilding;
                } else if (prop.villa) {
                    rent = data.rentVilla;
                } else {
                    rent = data.rentLand;
                }
            }
            
            if (gameState.olympicCity === cityName) {
                rent *= 3;
                addLog(`üèÖ Ïò¨Î¶ºÌîΩ Í∞úÏµú ÎèÑÏãú! ÌÜµÌñâÎ£å 3Î∞∞`);
            }
            
            if (player.cards.immunity > 0 && !player.isAI) {
                showModal('Î©¥Ï†úÍ∂å ÏÇ¨Ïö©', 'ÌÜµÌñâÎ£å Î©¥Ï†úÍ∂åÏùÑ ÏÇ¨Ïö©ÌïòÏãúÍ≤†ÏäµÎãàÍπå?', [
                    { text: 'ÏÇ¨Ïö©', class: 'btn-buy', action: () => {
                        player.cards.immunity--;
                        addLog(`${player.name} Î©¥Ï†úÍ∂å ÏÇ¨Ïö©!`);
                        closeModal();
                        updateAll();
                        if (isDouble) setTimeout(rollDice, 500);
                        else nextTurn();
                    }},
                    { text: 'ÏßÄÎ∂à', class: 'btn-pass', action: () => {
                        closeModal();
                        executeRentPayment(rent, owner, isDouble, cityName, prop);
                    }}
                ]);
                return;
            }
            
            if (player.isAI && player.cards.immunity > 0 && rent > player.money * 0.3) {
                player.cards.immunity--;
                addLog(`${player.name} Î©¥Ï†úÍ∂å ÏÇ¨Ïö©!`);
                updateAll();
                if (isDouble) setTimeout(rollDice, 500);
                else nextTurn();
                return;
            }
            
            executeRentPayment(rent, owner, isDouble, cityName, prop);
        }

        function executeRentPayment(rent, owner, isDouble, cityName, prop) {
            const player = gameState.players[gameState.currentPlayer];
            
            if (player.money >= rent) {
                player.money -= rent;
                owner.money += rent;
                addLog(`${player.name} ‚Üí ${owner.name} ÌÜµÌñâÎ£å ${rent.toLocaleString()}Ïõê`);
                showNotification(`${player.name} ‚Üí ${owner.name}\nÌÜµÌñâÎ£å ${rent.toLocaleString()}Ïõê ÏßÄÎ∂à`);
                updateAll();
                
                // ÎûúÎìúÎßàÌÅ¨ ÏóÜÏúºÎ©¥ Íµ¨Îß§ Ï†úÏïà
                if (!prop.landmark && !cityData[cityName].special) {
                    const data = cityData[cityName];
                    let buyPrice = data.land;
                    if (prop.villa) buyPrice += data.villa;
                    if (prop.building) buyPrice += data.building;
                    if (prop.hotel) buyPrice += data.hotel;
                    
                    if (player.isAI) {
                        if (player.money > buyPrice * 1.5 && Math.random() > 0.5) {
                            setTimeout(() => buyFromOwner(cityName, owner, buyPrice, isDouble), 2000);
                        } else {
                            if (isDouble) setTimeout(rollDice, 2000);
                            else setTimeout(nextTurn, 2000);
                        }
                    } else {
                        setTimeout(() => {
                            showModal('ÎèÑÏãú Íµ¨Îß§', `${cityName}ÏùÑ(Î•º) ${buyPrice.toLocaleString()}ÏõêÏóê Íµ¨Îß§ÌïòÏãúÍ≤†ÏäµÎãàÍπå?`, [
                                { text: 'Ïòà', class: 'btn-buy', action: () => {
                                    buyFromOwner(cityName, owner, buyPrice, isDouble);
                                }},
                                { text: 'ÏïÑÎãàÏöî', class: 'btn-pass', action: () => {
                                    closeModal();
                                    if (isDouble) setTimeout(rollDice, 500);
                                    else nextTurn();
                                }}
                            ]);
                        }, 2000);
                    }
                } else {
                    if (isDouble) setTimeout(rollDice, 2000);
                    else setTimeout(nextTurn, 2000);
                }
            } else {
                handleBankruptcy(player, owner, rent, isDouble);
            }
        }

        function buyFromOwner(cityName, owner, price, isDouble) {
            const player = gameState.players[gameState.currentPlayer];
            
            if (player.money >= price) {
                player.money -= price;
                owner.money += price;
                
                const propIndex = owner.properties.findIndex(p => p.name === cityName);
                const prop = owner.properties[propIndex];
                owner.properties.splice(propIndex, 1);
                player.properties.push(prop);
                
                addLog(`${player.name}Ïù¥(Í∞Ä) ${owner.name}Î°úÎ∂ÄÌÑ∞ ${cityName} Íµ¨Îß§!`);
                showNotification(`${player.name}\n${cityName} Ïù∏Ïàò!`);
                updateCityDisplay(cityName, player);
                updateAll();
                saveGame();
                
                closeModal();
                
                // Ï∂îÍ∞Ä Í±¥ÏÑ§ Ïó¨Î∂Ä Î¨ºÏñ¥Î≥¥Í∏∞
                const data = cityData[cityName];
                if (!prop.landmark && player.laps >= 1) {
                    setTimeout(() => {
                        if (player.isAI) {
                            if (player.money > data.hotel && Math.random() > 0.6) {
                                aiBuild(cityName, isDouble);
                            } else {
                                if (isDouble) setTimeout(rollDice, 500);
                                else nextTurn();
                            }
                        } else {
                            showBuildModal(cityName, isDouble);
                        }
                    }, 1000);
                } else {
                    if (isDouble) setTimeout(rollDice, 2000);
                    else setTimeout(nextTurn, 2000);
                }
            } else {
                closeModal();
                if (isDouble) setTimeout(rollDice, 2000);
                else setTimeout(nextTurn, 2000);
            }
        }

        function handleBankruptcy(player, creditor, debt, isDouble) {
            if (player.isAI && player.properties.length > 0) {
                // AI ÏûêÎèô Îß§Í∞Å
                while (player.money < debt && player.properties.length > 0) {
                    const prop = player.properties[0];
                    const data = cityData[prop.name];
                    let value = data.land;
                    if (prop.villa) value += data.villa;
                    if (prop.building) value += data.building;
                    if (prop.hotel) value += data.hotel;
                    if (prop.landmark) value += data.hotel * 2;
                    
                    player.money += value;
                    player.properties.shift();
                    updateCityDisplay(prop.name, null);
                    addLog(`${player.name} ${prop.name} Îß§Í∞Å: ${value.toLocaleString()}Ïõê`);
                }
                
                if (player.money >= debt) {
                    player.money -= debt;
                    creditor.money += debt;
                    addLog(`${player.name} ‚Üí ${creditor.name} ${debt.toLocaleString()}Ïõê ÏßÄÎ∂à`);
                    updateAll();
                    if (isDouble) setTimeout(rollDice, 1000);
                    else nextTurn();
                } else {
                    player.bankrupt = true;
                    addLog(`üíÄ ${player.name} ÌååÏÇ∞!`);
                    checkGameEnd();
                    if (isDouble) setTimeout(rollDice, 1000);
                    else nextTurn();
                }
            } else if (player.properties.length > 0) {
                showSellModal(player, debt, isDouble, creditor);
            } else {
                player.bankrupt = true;
                addLog(`üíÄ ${player.name} ÌååÏÇ∞!`);
                checkGameEnd();
                if (isDouble) setTimeout(rollDice, 1000);
                else nextTurn();
            }
        }

        function showSellModal(player, minAmount, isDouble, creditor) {
            const props = player.properties.map((p, i) => {
                const data = cityData[p.name];
                let value = data.land;
                if (p.villa) value += data.villa;
                if (p.building) value += data.building;
                if (p.hotel) value += data.hotel;
                if (p.landmark) value += data.hotel * 2;
                return { ...p, value, index: i };
            });
            
            let html = '<div class="property-list">';
            props.forEach((p, i) => {
                html += `<div class="property-item" onclick="sellProperty(${i}, ${isDouble}, ${minAmount}, '${creditor ? creditor.name : ''}')">${p.name} - ${p.value.toLocaleString()}Ïõê</div>`;
            });
            html += '</div>';
            
            showModal('Ïû¨ÏÇ∞ Îß§Í∞Å', `${minAmount.toLocaleString()}Ïõê ÌïÑÏöî (ÌòÑÏû¨: ${player.money.toLocaleString()}Ïõê)`, [], html);
        }

        window.sellProperty = function(index, isDouble, debt, creditorName) {
            const player = gameState.players[gameState.currentPlayer];
            const prop = player.properties[index];
            const data = cityData[prop.name];
            
            let value = data.land;
            if (prop.villa) value += data.villa;
            if (prop.building) value += data.building;
            if (prop.hotel) value += data.hotel;
            if (prop.landmark) value += data.hotel * 2;
            
            player.money += value;
            player.properties.splice(index, 1);
            updateCityDisplay(prop.name, null);
            addLog(`${prop.name} Îß§Í∞Å: ${value.toLocaleString()}Ïõê`);
            updateAll();
            
            if (player.money >= debt) {
                const creditor = gameState.players.find(p => p.name === creditorName);
                if (creditor) {
                    player.money -= debt;
                    creditor.money += debt;
                    addLog(`${player.name} ‚Üí ${creditor.name} ${debt.toLocaleString()}Ïõê ÏßÄÎ∂à`);
                }
                closeModal();
                updateAll();
                if (isDouble) setTimeout(rollDice, 1000);
                else nextTurn();
            } else {
                showSellModal(player, debt, isDouble, creditor);
            }
        };

        function handleOlympic(isDouble) {
            const player = gameState.players[gameState.currentPlayer];
            const buildCities = player.properties.filter(p => p.villa || p.building || p.hotel);
            
            if (buildCities.length === 0) {
                addLog(`${player.name} Í±¥Î¨º ÏóÜÏñ¥ÏÑú Ïò¨Î¶ºÌîΩ Í∞úÏµú Î∂àÍ∞Ä`);
                if (isDouble) setTimeout(rollDice, 500);
                else nextTurn();
                return;
            }
            
            if (player.isAI) {
                const selected = buildCities[Math.floor(Math.random() * buildCities.length)];
                setOlympic(selected.name, isDouble);
            } else {
                let html = '<div class="property-list">';
                buildCities.forEach((p, i) => {
                    html += `<div class="property-item" onclick="selectOlympic('${p.name}', ${isDouble})">${p.name}</div>`;
                });
                html += '</div>';
                showModal('Ïò¨Î¶ºÌîΩ Í∞úÏµú', 'ÎèÑÏãúÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî (ÌÜµÌñâÎ£å 3Î∞∞!)', [], html);
            }
        }

        window.selectOlympic = function(cityName, isDouble) {
            setOlympic(cityName, isDouble);
        };

        function setOlympic(cityName, isDouble) {
            gameState.olympicCity = cityName;
            addLog(`üèÖ ${cityName}ÏóêÏÑú Ïò¨Î¶ºÌîΩ Í∞úÏµú! ÌÜµÌñâÎ£å 3Î∞∞`);
            closeModal();
            if (isDouble) setTimeout(rollDice, 500);
            else nextTurn();
        }

        function showAirplaneChoice() {
            const player = gameState.players[gameState.currentPlayer];
            
            if (player.isAI) {
                const targetPos = Math.floor(Math.random() * 40);
                player.position = targetPos;
                if (targetPos < gameState.players[gameState.currentPlayer].position) {
                    player.money += 200000;
                    addLog(`${player.name} ÏõîÍ∏â 20ÎßåÏõê Î∞õÏùå`);
                }
                gameState.airplaneNext = null;
                updatePlayerPositions();
                setTimeout(() => handleLanding(false), 600);
            } else {
                let html = '<select id="citySelect" style="width:100%;padding:10px;margin:10px 0;">';
                boardLayout.forEach((city, i) => {
                    if (city !== 'Ìô©Í∏àÏó¥Ïá†' && city !== 'Ï∂úÎ∞ú' && city !== 'ÎπÑÌñâÍ∏∞') {
                        html += `<option value="${i}">${city}</option>`;
                    }
                });
                html += '</select>';
                
                showModal('ÎπÑÌñâÍ∏∞ Ïù¥Îèô', 'ÏõêÌïòÎäî ÎèÑÏãúÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî', [
                    { text: 'Ïù¥Îèô', class: 'btn-buy', action: () => {
                        const select = document.getElementById('citySelect');
                        const targetPos = parseInt(select.value);
                        player.position = targetPos;
                        if (targetPos < player.position) {
                            player.money += 200000;
                            addLog(`${player.name} ÏõîÍ∏â 20ÎßåÏõê Î∞õÏùå`);
                        }
                        gameState.airplaneNext = null;
                        closeModal();
                        updatePlayerPositions();
                        setTimeout(() => handleLanding(false), 600);
                    }}
                ], html);
            }
        }

        function aiBuild(cityName, isDouble) {
            const player = gameState.players[gameState.currentPlayer];
            const prop = player.properties.find(p => p.name === cityName);
            const data = cityData[cityName];
            
            if (data.special || player.laps === 0) {
                if (isDouble) setTimeout(rollDice, 500);
                else nextTurn();
                return;
            }
            
            if (prop.villa && prop.building && prop.hotel && !prop.landmark && player.money > data.hotel * 3) {
                buildLandmark(cityName, isDouble);
            } else if (!prop.villa && player.money > data.villa * 3 && Math.random() > 0.3) {
                build(cityName, 'villa', isDouble);
            } else if (prop.villa && !prop.building && player.laps >= 2 && player.money > data.building * 2.5 && Math.random() > 0.4) {
                build(cityName, 'building', isDouble);
            } else if (prop.building && !prop.hotel && player.laps >= 3 && player.money > data.hotel * 2 && Math.random() > 0.5) {
                build(cityName, 'hotel', isDouble);
            } else {
                if (isDouble) setTimeout(rollDice, 500);
                else nextTurn();
            }
        }

        function updateCityDisplay(cityName, owner) {
            const pos = boardLayout.indexOf(cityName);
            const cell = document.querySelector(`[data-position="${pos}"]`);
            if (!cell) return;
            
            let ownerEl = cell.querySelector('.cell-owner');
            if (!ownerEl && owner) {
                ownerEl = document.createElement('div');
                ownerEl.className = 'cell-owner';
                cell.appendChild(ownerEl);
            }
            
            if (ownerEl) {
                ownerEl.style.background = owner ? owner.color : 'transparent';
                ownerEl.style.display = owner ? 'block' : 'none';
            }
            
            const indicator = cell.querySelector('.building-indicator');
            indicator.innerHTML = '';
            
            if (owner) {
                const prop = owner.properties.find(p => p.name === cityName);
                if (prop) {
                    if (prop.villa) {
                        const v = document.createElement('div');
                        v.className = 'building villa';
                        indicator.appendChild(v);
                    }
                    if (prop.building) {
                        const b = document.createElement('div');
                        b.className = 'building building-type';
                        indicator.appendChild(b);
                    }
                    if (prop.hotel) {
                        const h = document.createElement('div');
                        h.className = 'building hotel';
                        indicator.appendChild(h);
                    }
                    if (prop.landmark) {
                        const l = document.createElement('div');
                        l.className = 'landmark';
                        indicator.appendChild(l);
                    }
                }
            }
            
            if (gameState.olympicCity === cityName) {
                let olympicEl = cell.querySelector('.olympic-marker');
                if (!olympicEl) {
                    olympicEl = document.createElement('div');
                    olympicEl.className = 'olympic-marker';
                    olympicEl.textContent = 'üèÖ';
                    cell.appendChild(olympicEl);
                }
            }
        }

        function showLandmarkEffect() {
            const effect = document.createElement('div');
            effect.className = 'landmark-effect';
            effect.textContent = '‚≠ê‚ú®üåüüí´';
            effect.style.left = '50%';
            effect.style.top = '50%';
            document.body.appendChild(effect);
            setTimeout(() => effect.remove(), 2000);
        }

        function showModal(title, text, buttons, extraHTML = '') {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalText').textContent = text;
            document.getElementById('modalExtra').innerHTML = extraHTML;
            
            const modalButtons = document.getElementById('modalButtons');
            modalButtons.innerHTML = '';
            
            buttons.forEach((btn, index) => {
                const button = document.createElement('button');
                button.className = `modal-button ${btn.class}`;
                button.textContent = btn.text;
                button.onclick = btn.action;
                modalButtons.appendChild(button);
            });
            
            document.getElementById('actionModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('actionModal').classList.remove('active');
        }

        function nextTurn() {
            do {
                gameState.currentPlayer = (gameState.currentPlayer + 1) % 4;
                if (gameState.currentPlayer === 0) {
                    gameState.turn++;
                    if (gameState.turn > 30) {
                        checkGameEnd();
                        return;
                    }
                }
            } while (gameState.players[gameState.currentPlayer].bankrupt);
            
            document.getElementById('rollButton').disabled = false;
            document.getElementById('currentTurn').textContent = `ÌÑ¥: ${gameState.players[gameState.currentPlayer].name}`;
            updateAll();
            
            if (gameState.players[gameState.currentPlayer].isAI) {
                setTimeout(rollDice, 1500);
            }
        }

        function checkGameEnd() {
            const alive = gameState.players.filter(p => !p.bankrupt);
            
            if (alive.length === 1 || gameState.turn > 100) {
                const sorted = gameState.players.slice().sort((a, b) => {
                    let aTotal = a.money;
                    let bTotal = b.money;
                    a.properties.forEach(p => {
                        const d = cityData[p.name];
                        aTotal += d.land;
                        if (p.villa) aTotal += d.villa;
                        if (p.building) aTotal += d.building;
                        if (p.hotel) aTotal += d.hotel;
                        if (p.landmark) aTotal += d.hotel * 2;
                    });
                    b.properties.forEach(p => {
                        const d = cityData[p.name];
                        bTotal += d.land;
                        if (p.villa) bTotal += d.villa;
                        if (p.building) bTotal += d.building;
                        if (p.hotel) bTotal += d.hotel;
                        if (p.landmark) bTotal += d.hotel * 2;
                    });
                    return bTotal - aTotal;
                });
                
                let totalAsset = sorted[0].money;
                sorted[0].properties.forEach(p => {
                    const d = cityData[p.name];
                    totalAsset += d.land;
                    if (p.villa) totalAsset += d.villa;
                    if (p.building) totalAsset += d.building;
                    if (p.hotel) totalAsset += d.hotel;
                    if (p.landmark) totalAsset += d.hotel * 2;
                });
                
                showModal('üéâ Í≤åÏûÑ Ï¢ÖÎ£å!', `Ïö∞Ïäπ: ${sorted[0].name}\nÏ¥ù ÏûêÏÇ∞: ${totalAsset.toLocaleString()}Ïõê`, [
                    { text: 'Îã§ÏãúÌïòÍ∏∞', class: 'btn-buy', action: () => {
                        location.reload();
                    }}
                ]);
            }
        }

        function addLog(msg) {
            const log = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = msg;
            log.insertBefore(entry, log.firstChild);
            if (log.children.length > 25) log.removeChild(log.lastChild);
        }

        document.getElementById('rollButton').addEventListener('click', rollDice);
        initGame();
    </script>
</body>
</html>
